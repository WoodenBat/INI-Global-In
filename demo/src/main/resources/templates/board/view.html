<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="${#locale.language}">
<head>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<title th:text="${board.board_title}">ê²Œì‹œê¸€ ë³´ê¸°</title>
<link rel="stylesheet" th:href="@{/css/boardReply.css}" />
<link rel="stylesheet" th:href="@{/css/popup.css}" />
<script th:src="@{/js/boardReply.js}"></script>
</head>
<th:block th:replace="member/header :: header"></th:block>
<script th:inline="javascript">
	let board_id = '[[${board.board_id}]]'; 
</script>
<body>
	<span id="localeClass" th:text="${#locale}" style="display: none;"></span>
	<h1 th:text="${board.board_title}">ì œëª©</h1>

	<!-- ê²Œì‹œê¸€ ì •ë³´ -->
	<div>
		<p>
			<strong>ë§ë¨¸ë¦¬:</strong>
			<span th:text="${board.tag_name}"></span>
		</p>
		<p>
			<strong>ì¹´í…Œê³ ë¦¬:</strong>
			<span th:text="${board.category_name}"></span>
		</p>
		<p>
			<strong>ì‘ì„±ì:</strong>
			<span th:text="${board.user_nickname}"></span>
		</p>
		<p>
			<strong>ì‘ì„±ì¼:</strong>
			<span th:text="${#dates.format(board.board_write_date, 'yyyy-MM-dd HH:mm')}"></span>
		</p>
		<p>
			<strong>ì¡°íšŒìˆ˜:</strong>
			<span th:text="${board.board_views}"></span>
		</p>
	</div>

	<hr>

	<!-- ê²Œì‹œê¸€ ë³¸ë¬¸ + ì´ë¯¸ì§€ -->
	<div class="reply-block">
		<!-- ë³¸ë¬¸ -->
		<div class="reply-text" th:text="${board.board_content}" style="white-space: pre-line;"></div>


		<!-- ë²ˆì—­ ë²„íŠ¼ -->
		<button type="button" class="translate_board-btn">ë²ˆì—­í•˜ê¸°</button>

		<!-- ì´ë¯¸ì§€ -->
		<div th:if="${imageList != null and !#lists.isEmpty(imageList)}">
			<div th:each="image : ${imageList}">
				<img th:if="${image.image_path != null and !#strings.isEmpty(image.image_path)}"
					th:src="@{'/uploads/' + ${image.image_path}}" th:alt="${image.original_name}"
					style="max-width: 100%; height: auto; margin-top: 10px;" />
			</div>
		</div>
	</div>

	<hr>

	<!-- ë²„íŠ¼ ì˜ì—­ -->
	<div style="margin-top: 20px;">
		<form th:action="@{/board/list}" method="get" style="display: inline;">
			<button type="submit" style="margin-right: 10px;">ëª©ë¡</button>
		</form>

		<form th:action="@{'/board/edit/' + ${board.board_id}}" method="get" style="display: inline;">
			<button type="submit" style="margin-right: 10px;">ìˆ˜ì •</button>
		</form>

		<form th:action="@{'/board/delete/' + ${board.board_id}}" method="post" style="display: inline;">
			<button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
		</form>
	</div>

	<!-- ì¢‹ì•„ìš” -->
	<div style="margin-top: 20px;">
		<button id="likeBtn">
			<span id="likeIcon" th:text="${liked} ? 'â¤ï¸' : 'ğŸ¤'"></span>
			<span id="likeCount" th:text="${likeCount}">0</span>
		</button>
	</div>

	<!-- ì¢‹ì•„ìš” JS -->
	<script>
		let isProcessing = false;
		document.getElementById("likeBtn").addEventListener("click", function () {
		    if (isProcessing) return;
		    isProcessing = true;
		    const boardId = '[[${board.board_id}]]';
		    fetch(`/board/like/${boardId}`, { method: 'POST' })
		        .then(res => res.json())
		        .then(data => {
		            document.getElementById("likeIcon").textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
		            document.getElementById("likeCount").textContent = data.likeCount;
		        })
		        .finally(() => isProcessing = false);
		});
	</script>

	<!-- ì‹ ê³ í•˜ê¸° -->
	<button id="reportBtn">ì‹ ê³ í•˜ê¸°</button>

	<div id="reportModal" style="display: none;">
		<form id="reportForm">
			<label>ì‹ ê³  ì¢…ë¥˜:</label> <select name="report_category" required>
				<option value="">ì„ íƒ</option>
				<option value="ìš•ì„¤">ìš•ì„¤</option>
				<option value="ìŠ¤íŒ¸">ìŠ¤íŒ¸</option>
				<option value="ê¸°íƒ€">ê¸°íƒ€</option>
			</select><br> <label>ì‹ ê³  ë‚´ìš©:</label><br>
			<textarea name="report_content" required></textarea>
			<br>
			<button type="submit">ì‹ ê³  ì œì¶œ</button>
			<button type="button" id="closeModal">ì·¨ì†Œ</button>
		</form>
	</div>

	<th:block th:replace="board/boardReplyTest :: boardReply"></th:block>

	<script>
		document.getElementById('reportBtn').addEventListener('click', () => {
		    document.getElementById('reportModal').style.display = 'block';
		});
		document.getElementById('closeModal').addEventListener('click', () => {
		    document.getElementById('reportModal').style.display = 'none';
		});
		document.getElementById('reportForm').addEventListener('submit', async (e) => {
		    e.preventDefault();
		    const form = e.target;
		    const data = {
		        board_id: '[[${board.board_id}]]',
		        report_category: form.report_category.value,
		        report_content: form.report_content.value
		    };
		
		    try {
		        const response = await fetch('/board/report', {
		            method: 'POST',
		            headers: {'Content-Type': 'application/json'},
		            body: JSON.stringify(data)
		        });
		
		        if (response.ok) {
		            alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
		            document.getElementById('reportModal').style.display = 'none';
		        } else {
		            const errorText = await response.text();
		            alert(errorText);
		        }
		    } catch (err) {
		        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		    }
		});
	</script>

	<script th:src="@{/js/TranslateRequest.js}"></script>
</body>
</html>