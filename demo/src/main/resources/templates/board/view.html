<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="${lang}">
<th:block th:replace="member/header :: header"></th:block>
<head>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<title th:text="${board.board_title}">ê²Œì‹œê¸€ ë³´ê¸°</title>
<link rel="stylesheet" th:href="@{/css/boardReply.css}" />
<link rel="stylesheet" th:href="@{/css/popup.css}" />
<script th:src="@{/js/boardReply.js}"></script>
<style>
@font-face {
	font-family: 'Ownglyph_PDH';
	src: url('/fonts/Ownglyph_PDH.ttf') format('truetype');
}

body {
	font-family: 'Ownglyph_PDH', sans-serif;
}

.info-label {
	font-weight: 600;
	margin-right: 8px;
}

.badge {
	display: inline-block;
	padding: 4px 14px;
	border-radius: 9999px;
	font-size: 15px;
	font-weight: 600;
	background-color: #f8e3c5;
	color: #000;
}

.content-box {
	background-color: #ffffff;
	padding: 20px;
	border-radius: 10px;
	border-top: 1px solid #ddd;
	border-bottom: 1px solid #ddd;
	margin-top: 20px;
}
</style>
</head>
<script th:inline="javascript">
	let board_id = '[[${board.board_id}]]'; 
</script>
<body>
	<span id="localeClass" th:text="${#locale}" style="display: none;"></span>
	<div class="max-w-4xl mx-auto">
		<h1 class="text-3xl font-bold mb-4" th:text="${board.board_title}">ì œëª©</h1>

		<!-- ê²Œì‹œê¸€ ì •ë³´ -->
		<div class="space-y-2 mb-6">
			<div class="flex flex-wrap items-center gap-x-6 gap-y-2">
				<div>
					<span class="info-label">ë§ë¨¸ë¦¬:</span>
					<span class="badge" th:text="${board.tag_name}"></span>
				</div>
				<div>
					<span class="info-label">ì¹´í…Œê³ ë¦¬:</span>
					<span class="badge" th:text="${board.category_name}"></span>
				</div>
				<div>
					<span class="info-label">ì‘ì„±ì:</span>
					<span th:text="${board.user_nickname}"></span>
				</div>
				<div>
					<span class="info-label">ì‘ì„±ì¼:</span>
					<span th:text="${#dates.format(board.board_write_date, 'yyyy-MM-dd HH:mm')}"></span>
				</div>
				<div>
					<span class="info-label">ì¡°íšŒìˆ˜:</span>
					<span th:text="${board.board_views}"></span>
				</div>
			</div>
		</div>

		<!-- ë³¸ë¬¸ -->
		<div class="reply-block">
			<div class="reply-text content-box mb-4" th:utext="${board.board_content}"></div>
			<div class="board_content_hidden" style="display: none;"></div>
		</div>

		<!-- ë²ˆì—­ ë²„íŠ¼ -->
		<button type="button" class="translate_board-btn mb-4 bg-blue-500 text-white px-4 py-2 rounded">ë²ˆì—­í•˜ê¸°</button>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="mt-6 flex justify-between items-center">
			<div class="flex gap-3">
				<form th:action="@{/board/list}" method="get">
					<button type="submit" th:class="${'bg-gray-300 px-4 py-2 rounded lang-' + lang}" th:text="#{board_view_list}"></button>
				</form>
				<form th:action="@{'/board/edit/' + ${board.board_id}}" method="get">
					<button type="submit" class="bg-yellow-400 px-4 py-2 rounded">ìˆ˜ì •</button>
				</form>
				<form th:action="@{'/board/delete/' + ${board.board_id}}" method="post">
					<button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="bg-red-400 px-4 py-2 rounded text-white">ì‚­ì œ</button>
				</form>
			</div>
			<div class="flex gap-4 items-center">
				<button id="likeBtn" class="text-2xl">
					<span id="likeIcon" th:text="${liked} ? 'â¤ï¸' : 'ğŸ¤'"></span>
					<span id="likeCount" th:text="${likeCount}">0</span>
				</button>
				<button id="reportBtn" class="bg-red-500 text-white px-4 py-2 rounded">ì‹ ê³ í•˜ê¸°</button>
			</div>
		</div>

		<!-- ì‹ ê³  ëª¨ë‹¬ -->
		<div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
			<div class="bg-white p-6 rounded shadow-lg w-96">
				<h3 class="text-lg font-semibold mb-4">ì‹ ê³ í•˜ê¸°</h3>

				<form id="reportForm" class="space-y-4" onkeydown="return event.key !== 'Enter';">
					<input type="hidden" id="report_board_id" th:value="${board.board_id}" />
					<input type="hidden" id="report_user" th:value="${session.loginUser}" />

					<div>
						<label class="block font-medium mb-1">ì‹ ê³  ì‚¬ìœ </label>
						<select id="report_category" class="w-full border px-3 py-2 rounded" required>
							<option value="">ì„ íƒí•˜ì„¸ìš”</option>
							<option value="ìš•ì„¤">ìš•ì„¤</option>
							<option value="ë„ë°°">ë„ë°°</option>
							<option value="ê´‘ê³ ">ê´‘ê³ </option>
							<option value="ê¸°íƒ€">ê¸°íƒ€</option>
						</select>
					</div>

					<div>
						<label class="block font-medium mb-1">ìƒì„¸ ë‚´ìš©</label>
						<textarea id="report_content" class="w-full border px-3 py-2 rounded" rows="4" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
					</div>

					<div class="flex justify-end gap-2">
						<button type="submit" class="bg-red-500 text-white px-4 py-1 rounded">ì‹ ê³  ì œì¶œ</button>
						<button type="button" id="closeModal" class="bg-gray-300 px-4 py-1 rounded">ì·¨ì†Œ</button>
					</div>
				</form>
			</div>
		</div>

		<!-- ì¢‹ì•„ìš” JS -->
		<script>
		    let isProcessing = false;
		    document.getElementById("likeBtn").addEventListener("click", function () {
		      if (isProcessing) return;
		      isProcessing = true;
		      const boardId = '[[${board.board_id}]]';
		      fetch(`/board/like/${boardId}`, { method: 'POST' })
		        .then(res => res.json())
		        .then(data => {
		          document.getElementById("likeIcon").textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
		          document.getElementById("likeCount").textContent = data.likeCount;
		        })
		        .finally(() => isProcessing = false);
		    });
	  	</script>

		<!-- ì‹ ê³  JS -->
		<script>
		  document.getElementById('reportBtn').addEventListener('click', () => {
			  document.getElementById('reportModal').style.display = 'flex';
			});
		
			document.getElementById('closeModal').addEventListener('click', () => {
			  document.getElementById('reportModal').style.display = 'none';
			});
		
			document.getElementById('reportForm').addEventListener('submit', async (e) => {
			  e.preventDefault();
		
			  const data = {
			    board_id: document.getElementById('report_board_id').value,
			    report_user: document.getElementById('report_user').value,
			    report_category: document.getElementById('report_category').value,
			    report_content: document.getElementById('report_content').value
			  };
		
			  if (!data.report_category) {
			    alert('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
			    return;
			  }
		
			  try {
			    const response = await fetch('/board/report', {
			      method: 'POST',
			      headers: { 'Content-Type': 'application/json' },
			      body: JSON.stringify(data)
			    });
		
			    if (response.ok) {
			      alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
			      document.getElementById('reportModal').style.display = 'none';
			    } else {
			      const errorText = await response.text();
			      alert(errorText);
			    }
			  } catch (err) {
			    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			    console.error(err);
			  }
			  if (data.report_category === "ê¸°íƒ€" && data.report_content.trim() === "") {
				  alert("ê¸°íƒ€ ì‚¬ìœ ëŠ” ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				  return;
				}
			});
	  	</script>
		<th:block th:replace="board/boardReplyTest :: boardReply"></th:block>

		<!-- ë²ˆì—­ JS -->
		<script>
		  $(document).ready(function () {
			  function translateText(text) {
			    return fetch("/api/translate", {
			      method: "POST",
			      headers: { "Content-Type": "application/json" },
			      body: JSON.stringify({ input: text })
			    }).then(res => {
			      if (!res.ok) throw new Error("ë²ˆì—­ ì‹¤íŒ¨");
			      return res.text();
			    });
			  }
		
			  // ì¬ê·€ì ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë…¸ë“œë§Œ ë²ˆì—­
			  async function translateNodes(node) {
			    const children = [...node.childNodes];
			    for (let child of children) {
			      if (child.nodeType === Node.TEXT_NODE && child.textContent.trim()) {
			        const translated = await translateText(child.textContent.trim());
			        console.log("âœ… ë²ˆì—­:", translated);
			        child.textContent = translated + " (ë²ˆì—­)";
			      } else if (child.nodeType === Node.ELEMENT_NODE) {
			        await translateNodes(child); // í•˜ìœ„ ë…¸ë“œ ì¬ê·€ ì²˜ë¦¬
			      }
			    }
			  }
		
			  $(document).on("click", ".translate_board-btn", async function () {
			    console.log("âœ… ë²ˆì—­ ë²„íŠ¼ í´ë¦­ë¨");
		
			    const textElem = $(".reply-text")[0];
			    const backup = $(".board_content_hidden");
		
			    if (backup.text().trim() === "") {
			      backup.html($(textElem).html());
		
			      try {
			        await translateNodes(textElem);
			        $(textElem).css("font-size", "15px");
			      } catch (err) {
			        console.error("âŒ ë²ˆì—­ ì‹¤íŒ¨:", err);
			        alert("ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
			      }
		
			    } else {
			      $(".reply-text").html(backup.html());
			      backup.text("");
			    }
			  });
			});;
		</script>

		<script th:src="@{/js/TranslateRequest.js}"></script>
</body>
</html>