<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>프로필 수정</title>
</head>
<th:block th:replace="member/header :: header"></th:block>
<body>
	<form id="profileImageForm" th:action="@{/member/memberProfileUpdate}" method="post"
		enctype="multipart/form-data" onsubmit="return confirmSubmit();">

		<!-- 이미지 업로드 -->
		<div style="margin-top: 20px;">
			<label for="profileUploadInput"> <img
				th:src="@{${member_info.user_profile_img_path != null} 
                        ? '/uploads/profile/' + ${member_info.user_profile_img_path} 
                        : '/images/default-profile.png'}"
				class="profile_image" alt="프로필 사진" />
			</label>
			<input id="profileUploadInput" type="file" name="profileImage" accept="image/*" />
		</div>

		<!-- 자기소개 -->
		<div class="form-group" style="margin-top: 10px;">
			<label for="user_intro">자기소개 (최대 100자)</label>
			<br />
			<textarea name="user_intro" maxlength="100" rows="3" cols="50" placeholder="한 줄 자기소개를 입력하세요.">[[${member_info.user_intro}]]</textarea>
			<button type="submit" name="mode" value="intro">상태메시지 수정</button>
		</div>

		<!-- 제출 버튼 -->
		<button type="submit" name="mode" value="both">프로필 전체 수정</button>

		<!-- 성공 메시지 -->
		<p th:if="${param.success}" style="color: green;">프로필이 성공적으로 수정되었습니다!</p>
	</form>

	<script>
        document.addEventListener("DOMContentLoaded", function () {
            const uploadBtn = document.getElementById('submit_button');
            const fileInput = document.getElementById('profileUploadInput');
            const form = document.getElementById('profileImageForm');

            uploadBtn.addEventListener('click', function (event) {
                // 기본 동작 막기
                event.preventDefault();

                if (!fileInput.files.length) {
                    alert("먼저 파일을 선택해주세요.");
                    return;
                }

                const confirmed = confirm("선택한 이미지로 프로필 사진을 변경하시겠습니까?");
                if (confirmed) {
                    form.submit(); // 수동 제출
                }
            });
        });

        document.getElementById("profileUploadInput")
                .addEventListener(
                        "change",
                        function (e) {
                            const file = e.target.files[0];
                            if (!file)
                                return;

                            const reader = new FileReader();
                            reader.onload = function (event) {
                                const imgTag = document
                                        .querySelector(".profile_image");
                                imgTag.src = event.target.result;
                            };
                            reader.readAsDataURL(file);
                        });
    </script>
</body>
</html>